' Gambas class file

' Copyright (C) 2025 Murilo Gomes Julio
' SPDX-License-Identifier: GPL-2.0-only

' Site: https://www.mugomes.com.br

Public dbPath As String = User.Home & "/.config/miprotocolo/dados/"
Public dbName As String = "miprotocolo.sqlite"

Private $conecta As Connection

Private Function checkColumn(nome As String, coluna As String) As Boolean 

  Dim $conecta1 As Connection
  $conecta1 = New Connection
  $conecta1.Type = "sqlite3"
  $conecta1.Host = dbPath 
  $conecta1.Name = dbName
  $conecta1.Open()
  
  Dim a As Boolean = False 
  Dim sql As String = "PRAGMA table_info(" & nome & ")"
  Dim rs As Result = $conecta1.Exec(sql)
  
  While (rs.Available)
    If rs[1] = coluna Then 
      a = True
      Exit
    Endif 
    
    rs.MoveNext()
  Wend
  
  $conecta1.Close()
  
  Return a
  
End

Private Sub createDB()
  
  If Exist(dbPath & dbName) = False Then 
    Shell "mkdir -p \"" & dbPath & "\"" Wait 
    
    $conecta = New Connection
    $conecta.Type = "sqlite3"
    $conecta.Host = dbPath
    $conecta.Name = ""
    $conecta.Open
    $conecta.Databases.Add(dbName)
    $conecta.Close()
  Endif 
  
  Try $conecta.Close()
  $conecta = New Connection
  $conecta.Type = "sqlite3"
  $conecta.Host = dbPath 
  $conecta.Name = dbName
  $conecta.Open()
  
  Dim sql As String = "CREATE TABLE IF NOT EXISTS mi_clientes (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, nome TEXT NOT NULL);"
  
  If False = checkColumn("mi_clientes", "cpf") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN cpf TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "datadenascimento") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN datadenascimento TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "telefone") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN telefone TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "email") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN email TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "endereco") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN endereco TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "endnum") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN endnum TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "bairro") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN bairro TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "complemento") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN complemento TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "cep") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN cep TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "cidade") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN cidade TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "estado") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN estado TEXT;"
  Endif
  
  If False = checkColumn("mi_clientes", "comentario") Then
    sql &= "ALTER TABLE mi_clientes ADD COLUMN comentario TEXT;"
  Endif
  
  sql &= "CREATE TABLE IF NOT EXISTS mi_protocolos (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, nome TEXT NOT NULL, descricao TEXT NOT NULL);"
  
  sql &= "CREATE TABLE IF NOT EXISTS mi_options (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, nome TEXT NOT NULL);"
  
  $conecta.Exec(sql)
  
  $conecta.Close()  
  
End

Private Function getIDCliente(id As Integer) As String
  
  Dim txt As String = ""
  Dim $conecta1 As Connection
  
  Try $conecta1.Close()
  $conecta1 = New Connection
  $conecta1.Type = "sqlite3"
  $conecta1.Host = dbPath 
  $conecta1.Name = dbName
  $conecta1.Open()
  
  Dim rs As Result = $conecta1.Exec("SELECT id,nome FROM mi_clientes WHERE id=&1", id)
  
  While (rs.Available)
    txt = rs!nome
    rs.MoveNext()
  Wend
  $conecta1.Close()
  
  Return txt   
  
End

Public Sub carregarDados()
  
  cv.Clear()
  
  Try $conecta.Close()
  $conecta = New Connection
  $conecta.Type = "sqlite3"
  $conecta.Host = dbPath 
  $conecta.Name = dbName
  $conecta.Open()
  
  Dim rs As Result = $conecta.Exec("SELECT * FROM mi_protocolos")
  
  While (rs.Available)
    cv.Add(rs!id, rs!id)
    If IsInteger(rs!nome) = True Then 
      cv[rs!id][1] = getIDCliente(rs!nome)
    Else 
      cv[rs!id][1] = rs!nome
    Endif 
    rs.MoveNext()
  Wend
  $conecta.Close()
  
End

Public Sub Form_Open()
  
  createDB()
  
  cv.Columns.Count = 2
  cv.Columns[0].Text = "ID"
  cv.Columns[0].Width = 100
  cv.Columns[1].Text = "Nome"
  cv.Columns[1].Width = 479
  cv.Header = True
  
  carregarDados()
  
End

Public Sub mnuClientes_Click()
  
  FCList.ShowDialog()
  
End

Public Sub btnEditar_Click()
  
  cv_DblClick
  
End

Public Sub cv_DblClick()
  
  If Not IsNull(cv.Key) Then
    FPAdd.sID = cv[cv.Key][0]
    FPAdd.ShowDialog()
    Try cv[cv.Key].Selected = False
  Endif
  
End

Public Sub btnExcluir_Click()
  
  If cv.Selection.Count > 0 Then 
    If Message.Question(Subst("Deseja excluir o(s) &1 registro(s) selecionado(s)?", cv.Selection.Count), "Sim", "NÃ£o") = 1 Then 
      Try $conecta.Close()
      $conecta = New Connection
      $conecta.Type = "sqlite3"
      $conecta.Host = dbPath 
      $conecta.Name = dbName
      $conecta.Open()
      
      For Each row As Integer In cv.Selection
        $conecta.Exec("DELETE FROM mi_protocolos WHERE id=&1", row)
      Next 
      
      $conecta.Close()
      
      cv.Remove(cv.Key)
      
      carregarDados()
    Endif 
  Endif 
  
End

Public Sub btnAdd_Click()
  
  FPAdd.ShowDialog()
  
End

Public Sub mnuProtocolosRelatorio_Click()
  
  Dim Report1 As New ReportP
  
  Report1.Preview()
  
End

Public Sub mnuConfigEmpresa_Click()
  
  FOptions.ShowDialog()
  
End

Public Sub mnuSobre_Click()
  
  FAbout.ShowDialog()
  
End

Public Sub mnuProtocolosSelecionar_Click()
  
  FSelecionar.ShowDialog()
  
End


Public Sub mnuCheckUpdate_Click()

  Shell "xdg-open \"https://www.mugomes.com.br/2025/07/miprotocolo.html\""

End

Public Sub mnuAssinantes_Click()

   Shell "xdg-open \"https://www.mugomes.com.br/p/assinantes.html\""

End
